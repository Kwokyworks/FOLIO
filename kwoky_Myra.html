<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOLIO Instance Search</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --background: #f5f6fa;
            --text: #333;
            --border: #ddd;
            --light-bg: #f9f9f9;
            --success: #27ae60;
            --error: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--background);
            color: var(--text);
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        h2 {
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 8px;
            margin: 0 0 20px;
            font-size: 1.8em;
            text-align: center;
        }

        h3 {
            color: var(--primary);
            margin: 10px 0;
            font-size: 1.2em;
            cursor: pointer;
        }

        h4 {
            color: var(--primary);
            margin: 5px 0;
            font-size: 1.1em;
        }

        #loginSection {
            max-width: 400px;
            margin: 50px auto 20px;
            padding: 25px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .login-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-size: 0.95em;
            color: var(--primary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 0.9em;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .secondary-button {
            background: transparent;
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .secondary-button:hover {
            background: #e6f0fa;
        }

        #logoutButton {
            background: var(--accent);
            margin: 0 0 20px;
        }

        #logoutButton:hover {
            background: #c0392b;
        }

        #loginError {
            color: var(--accent);
            font-size: 0.9em;
            margin-top: 10px;
            text-align: center;
        }

        #searchForm {
            display: grid;
            gap: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .search-row {
            display: grid;
            gap: 15px;
        }

        .single-line {
            grid-template-columns: repeat(3, 1fr);
            align-items: end;
        }

        .multi-selects {
            display: flex;
            gap: 20px;
            background: var(--light-bg);
            padding: 15px;
            border-radius: 4px;
        }

        .multi-select-container {
            flex: 1;
            position: relative;
        }

        .multi-select-container select[multiple] {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
        }

        .tooltip {
            position: relative;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8em;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .search-actions {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
        }

        .column-select {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }

        .column-group {
            display: grid;
            gap: 10px;
        }

        .basic-fields {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .column-select label {
            margin: 0;
            font-size: 0.85em;
            cursor: pointer;
        }

        .column-select input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
            vertical-align: middle;
        }

        /* MARC Field Controls Container */
        .marc-field-control {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            /* Increased for better spacing */
            align-items: flex-start;
            padding: 10px;
            background: var(--light-bg);
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        /* Input Wrapper */
        .marc-field-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 220px;
            max-width: 320px;
        }

        /* Input Styling */
        #marcFieldInput {
            width: 100%;
            padding: 8px 12px;
            font-size: 0.9em;
            border-radius: 4px;
            border: 1px solid var(--border);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #marcFieldInput:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        #marcFieldInput.valid {
            border-color: var(--success);
            background: #f0fff0;
            /* Light green background for valid input */
        }

        #marcFieldInput.invalid {
            border-color: var(--error);
            background: #fff0f0;
            /* Light red background for invalid input */
        }

        /* Datalist Suggestions */
        #marcSuggestions {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
            position: absolute;
            z-index: 10;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* MARC Tags Display */
        .marc-field-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 30px;
            /* Ensures space even when empty */
            padding: 5px;
            border: 1px dashed var(--border);
            /* Visual cue for tag area */
            border-radius: 4px;
        }

        .marc-field-tag {
            background: var(--secondary);
            color: white;
            padding: 4px 10px;
            border-radius: 16px;
            /* More rounded for a modern look */
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.3s;
        }

        .marc-field-tag:hover {
            background: #2980b9;
            /* Darker hover effect */
        }

        .marc-field-tag .remove-tag {
            background: rgba(255, 255, 255, 0.2);
            /* Subtle background for remove button */
            color: white;
            border: none;
            padding: 0;
            font-size: 1em;
            cursor: pointer;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .marc-field-tag .remove-tag:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Update Button */
        #updateResults {
            padding: 8px 16px;
            font-size: 0.9em;
            background: var(--secondary);
            color: white;
            border-radius: 4px;
            transition: background 0.3s;
        }

        #updateResults:hover {
            background: #2980b9;
        }

        /* Empty State */
        .marc-field-tags:empty::before {
            content: "No MARC fields selected";
            color: #777;
            font-style: italic;
            padding: 5px;
        }

        #results {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            flex-grow: 1;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }

        th,
        td {
            padding: 8px;
            border: 1px solid var(--border);
            text-align: left;
        }

        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: #f8f9fd;
        }

        tr:hover {
            background: #eef2f7;
        }

        .marc-field {
            max-width: 180px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.85em;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            gap: 5px;
        }

        .pagination button {
            min-width: 25px;
            padding: 6px;
        }

        .pagination .current-page {
            background: var(--primary);
        }

        .pagination span {
            margin: 0 5px;
            font-size: 0.9em;
        }

        #resultSummary {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .hidden {
            display: none !important;
        }

        #loadingIndicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 4px;
            display: none;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <h2>FOLIO Malaysia Research Assessment (MyRA) Lookup Tool</h2>

    <div id="loginSection">
        <form id="loginForm" class="login-form">
            <div class="form-group">
                <label for="endpoint">Endpoint</label>
                <select id="endpoint" required>
                    <option value="https://okapi-demo2.folio.ebsco.com">Demo2</option>
                    <option value="https://okapi-tarumt.folio.ebsco.com">TARUMT</option>
                    <option value="https://okapi-demo1.folio.ebsco.com">Demo 1</option>
                    <option value="https://okapi-demo.folio.ebsco.com">Demo</option>
                    <option value="https://folio-okapi.example.com">Example FOLIO</option>
                    <option value="https://okapi-test.folio.org">Test Environment</option>
                </select>
            </div>
            <div class="form-group">
                <label for="tenant">Tenant</label>
                <select id="tenant" required>
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter password" required>
            </div>
            <div class="form-actions">
                <button type="submit">Login</button>
            </div>
            <p id="loginError"></p>
        </form>
    </div>

    <main>
        <button id="logoutButton" class="hidden">Logout</button>

        <form id="searchForm" class="hidden">
            <div class="search-row single-line" id="searchInputs">
                <div class="form-group">
                    <label for="keyword">Title</label>
                    <input type="text" id="keyword" placeholder="e.g., Harry Potter">
                </div>
                <div class="form-group">
                    <label for="subject">Subject</label>
                    <input type="text" id="subject" placeholder="e.g., Wizards">
                </div>
                <div class="form-group tooltip">
                    <label for="electronicAccess">Electronic Access</label>
                    <select id="electronicAccess">
                        <option value="">Any</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                    <span class="tooltiptext">Filter by electronic access availability</span>
                </div>
            </div>
            <div class="search-row multi-selects" id="multiSelects">
                <div class="multi-select-container">
                    <label for="location">Location</label>
                    <select id="location" multiple>
                        <option value="">Any</option>
                    </select>
                </div>
                <div class="multi-select-container">
                    <label for="materialType">Material Type</label>
                    <select id="materialType" multiple>
                        <option value="">Any</option>
                    </select>
                </div>
            </div>
            <div class="search-actions">
                <button type="submit" id="searchButton"><span>üîç</span> Search</button>
                <button type="button" id="resetForm" class="secondary-button"><span>‚ü≥</span> Reset</button>
                <button type="button" id="exportCSV" class="secondary-button" onclick="exportToCSV()">Export
                    CSV</button>
                <button type="button" id="exportJSON" class="secondary-button" onclick="exportToJSON()">Export
                    JSON</button>
            </div>
        </form>

        <div id="columnSelect" class="column-select hidden">
            <h3>Display Columns</h3>
            <div class="column-group">
                <h4>Basic Fields</h4>
                <div class="basic-fields">
                    <label><input type="checkbox" id="colTitle" checked> Title</label>
                    <label><input type="checkbox" id="colId" checked> Instance ID</label>
                    <label><input type="checkbox" id="colHrid" checked> HRID</label>
                    <label><input type="checkbox" id="colSubjects"> Subjects</label>
                    <label><input type="checkbox" id="colElectronic" checked> Electronic Access</label>
                    <label><input type="checkbox" id="colSrsId" checked> SRS ID</label>
                </div>
            </div>
            <div class="column-group marc-fields-collapsible">
                <h3 onclick="toggleMarcFields()">MARC Fields ‚ñæ</h3>
                <div id="marcFieldsContent" class="marc-fields-content">
                    <div class="marc-field-control">
                        <div class="marc-field-input-wrapper">
                            <input type="text" id="marcFieldInput" placeholder="e.g., 020$a or ISBN $a"
                                list="marcSuggestions">
                            <datalist id="marcSuggestions">
                                <option value="020">ISBN</option>
                                <option value="020$a">ISBN Number</option>
                                <option value="100">Personal Name</option>
                                <option value="100$a">Author Name</option>
                                <option value="245">Title Proper</option>
                                <option value="245$a">Title</option>
                                <option value="245$c">Statement of Responsibility</option>
                                <option value="260">Publication</option>
                                <option value="260$a">Place of Publication</option>
                                <option value="260$b">Publisher</option>
                                <option value="260$c">Date of Publication</option>
                                <option value="264">Production/Publication</option>
                                <option value="264$a">Place of Production</option>
                                <option value="264$b">Producer/Publisher</option>
                                <option value="264$c">Date of Production</option>
                            </datalist>
                        </div>
                        <br>
                        <button type="button" id="updateResults" class="secondary-button">Update Results</button>
                    </div>
                    <div id="marcFieldTags" class="marc-field-tags"></div>
                </div>
            </div>
        </div>

        <div id="results">
            <div id="resultSummary">
                <div id="summaryText"></div>
            </div>
            <div id="resultsTable"></div>
            <div id="loadingIndicator">Loading...</div>
        </div>

        <div id="pagination" class="pagination hidden"></div>
    </main>

    <script>
        let OKAPI_URL = '';
        let TENANT_ID = '';
        let token = null;
        let currentQuery = '';
        let currentPage = 0;
        const pageSize = 50;
        let totalRecords = 0;
        let currentResults = [];
        let marcFieldsToDisplay = { mainFields: [], subFields: [] };

        const endpointTenants = {
            'https://okapi-demo.folio.ebsco.com': [
                { value: 'fs00000002', text: 'fs00001234' }
            ],
            'https://okapi-tarumt.folio.ebsco.com': [
                { value: 'fs00001234', text: 'fs00001234' }
            ],
            'https://okapi-demo2.folio.ebsco.com': [
                { value: 'fs00001176', text: 'fs00001176' }
            ],
            'https://okapi-demo1.folio.ebsco.com': [
                { value: 'idksoguess', text: 'idksoguess' }
            ],
            'https://okapi-demo2.folio.ebsco.com': [
                { value: 'fs00001176', text: 'fs00001176 (Default)' }
            ],
            'https://folio-okapi.example.com': [
                { value: 'diku', text: 'DIKU' },
                { value: 'example_lib', text: 'Example Library' }
            ],
            'https://okapi-test.folio.org': [
                { value: 'test_tenant', text: 'Test Tenant' },
                { value: 'test_dev', text: 'Test Development' }
            ]
        };

        const marcFieldLabels = {
            '020': 'ISBN',
            '020$a': 'ISBN Number',
            '100': 'Personal Name',
            '100$a': 'Author Name',
            '245': 'Title Proper',
            '245$a': 'Title',
            '245$c': 'Statement of Responsibility',
            '260': 'Publication',
            '260$a': 'Place of Publication',
            '260$b': 'Publisher',
            '260$c': 'Date of Publication',
            '264': 'Production/Publication',
            '264$a': 'Place of Production',
            '264$b': 'Producer/Publisher',
            '264$c': 'Date of Production'
        };

        function populateTenantDropdown(endpoint) {
            const tenantSelect = document.getElementById('tenant');
            tenantSelect.innerHTML = '';
            const tenants = endpointTenants[endpoint] || [];
            tenants.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant.value;
                option.textContent = tenant.text;
                tenantSelect.appendChild(option);
            });
        }

        const endpointSelect = document.getElementById('endpoint');
        populateTenantDropdown(endpointSelect.value);

        endpointSelect.addEventListener('change', (e) => {
            populateTenantDropdown(e.target.value);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const searchForm = document.getElementById('searchForm');
            searchForm.classList.add('hidden');
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            OKAPI_URL = document.getElementById('endpoint').value;
            TENANT_ID = document.getElementById('tenant').value;
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            try {
                const response = await fetch(`${OKAPI_URL}/authn/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-okapi-tenant': TENANT_ID
                    },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) throw new Error('Login failed. Check credentials.');
                const data = await response.json();
                token = response.headers.get('x-okapi-token') || data.okapiToken;
                if (!token) throw new Error('No token received.');

                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('searchForm').classList.remove('hidden');
                document.getElementById('columnSelect').classList.remove('hidden');
                document.getElementById('logoutButton').classList.remove('hidden');
                document.getElementById('loginError').textContent = '';

                await populateLocations();
                await populateMaterialTypes();
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginError').textContent = error.message;
            }
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            token = null;
            OKAPI_URL = '';
            TENANT_ID = '';
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('searchForm').classList.add('hidden');
            document.getElementById('columnSelect').classList.add('hidden');
            document.getElementById('logoutButton').classList.add('hidden');
            document.getElementById('resultsTable').innerHTML = '';
            document.getElementById('summaryText').textContent = '';
            document.getElementById('pagination').classList.add('hidden');
            document.getElementById('loginForm').reset();
            marcFieldsToDisplay = { mainFields: [], subFields: [] };
            updateMarcFieldTags();
        });

        async function populateLocations() {
            try {
                const response = await fetch(`${OKAPI_URL}/locations?limit=1000`, {
                    headers: { 'x-okapi-tenant': TENANT_ID, 'x-okapi-token': token, 'Accept': 'application/json' }
                });
                if (!response.ok) throw new Error('Failed to fetch locations');
                const data = await response.json();
                const locationSelect = document.getElementById('location');
                const sortedLocations = data.locations.sort((a, b) => a.name.localeCompare(b.name));
                sortedLocations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.id;
                    option.textContent = loc.name;
                    locationSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching locations:', error);
            }
        }

        async function populateMaterialTypes() {
            try {
                const response = await fetch(`${OKAPI_URL}/material-types?limit=1000`, {
                    headers: { 'x-okapi-tenant': TENANT_ID, 'x-okapi-token': token, 'Accept': 'application/json' }
                });
                if (!response.ok) throw new Error('Failed to fetch material types');
                const data = await response.json();
                const materialTypeSelect = document.getElementById('materialType');
                const sortedMaterialTypes = data.mtypes.sort((a, b) => a.name.localeCompare(b.name));
                sortedMaterialTypes.forEach(mt => {
                    const option = document.createElement('option');
                    option.value = mt.id;
                    option.textContent = mt.name;
                    materialTypeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching material types:', error);
            }
        }

        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!token) {
                alert('Please log in first.');
                return;
            }

            const searchButton = document.getElementById('searchButton');
            searchButton.disabled = true;

            const keyword = document.getElementById('keyword').value.trim();
            const locationSelect = document.getElementById('location');
            const locations = Array.from(locationSelect.selectedOptions)
                .filter(option => option.value !== '')
                .map(option => option.value);
            const materialTypeSelect = document.getElementById('materialType');
            const materialTypes = Array.from(materialTypeSelect.selectedOptions)
                .filter(option => option.value !== '')
                .map(option => option.value);
            const subject = document.getElementById('subject').value.trim();
            const electronicAccess = document.getElementById('electronicAccess').value;

            const conditions = [];
            if (keyword) conditions.push(`title="${keyword}"`);
            if (locations.length > 0) {
                conditions.push(`holdings.permanentLocationId==(${locations.map(loc => `"${loc}"`).join(' or ')})`);
            }
            if (materialTypes.length > 0) {
                conditions.push(`items.materialTypeId==(${materialTypes.map(mt => `"${mt}"`).join(' or ')})`);
            }
            if (subject) conditions.push(`subjects=="${subject}"`);
            if (electronicAccess === 'true') {
                conditions.push('(electronicAccess all "*" or holdings.electronicAccess all "*")');
            }
            if (electronicAccess === 'false') {
                conditions.push('(electronicAccess="" and holdings.electronicAccess="")');
            }

            if (conditions.length === 0) {
                alert('Please enter at least one search criterion.');
                searchButton.disabled = false;
                return;
            }

            currentQuery = conditions.join(' and ');
            console.log('Generated CQL Query:', currentQuery);
            currentPage = 0;
            await fetchPage(currentPage);
            searchButton.disabled = false;
        });

        document.getElementById('resetForm').addEventListener('click', () => {
            document.getElementById('searchForm').reset();
            document.getElementById('resultsTable').innerHTML = '';
            document.getElementById('summaryText').textContent = '';
            document.getElementById('pagination').classList.add('hidden');
            currentQuery = '';
            currentResults = [];
            marcFieldsToDisplay = { mainFields: [], subFields: [] };
            updateMarcFieldTags();
        });

        async function fetchPage(page) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';

            try {
                const offset = page * pageSize;
                const url = `${OKAPI_URL}/search/instances?query=${encodeURIComponent(currentQuery)}&limit=${pageSize}&offset=${offset}`;
                console.log('Fetching URL:', url);
                const response = await fetch(url, {
                    headers: {
                        'x-okapi-tenant': TENANT_ID,
                        'x-okapi-token': token,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                totalRecords = data.totalRecords || 0;

                if (!data.instances || data.instances.length === 0) {
                    console.warn('No instances found in response');
                    displayResults([]);
                    updatePagination();
                    loadingIndicator.style.display = 'none';
                    return;
                }

                const instancesWithDetails = await Promise.all(data.instances.map(async (instance) => {
                    try {
                        const instanceResponse = await fetch(`${OKAPI_URL}/inventory/instances/${instance.id}`, {
                            headers: { 'x-okapi-tenant': TENANT_ID, 'x-okapi-token': token, 'Accept': 'application/json' }
                        });

                        if (!instanceResponse.ok) {
                            console.warn(`Instance ${instance.id} fetch failed`);
                            instance.marcFields = {};
                            instance.srsId = 'N/A';
                            instance.hasElectronicAccess = instance.electronicAccess?.length > 0;
                            return instance;
                        }

                        const instanceData = await instanceResponse.json();
                        const isMarcBased = instanceData.source?.toLowerCase().includes('marc');
                        instance.srsId = instanceData.sourceRecordIds?.[0] || 'N/A';
                        instance.hrid = instanceData.hrid || 'N/A';

                        const holdingsResponse = await fetch(`${OKAPI_URL}/holdings-storage/holdings?query=instanceId=="${instance.id}"`, {
                            headers: { 'x-okapi-tenant': TENANT_ID, 'x-okapi-token': token, 'Accept': 'application/json' }
                        });

                        let hasElectronicHoldings = false;
                        if (holdingsResponse.ok) {
                            const holdingsData = await holdingsResponse.json();
                            hasElectronicHoldings = holdingsData.holdingsRecords?.some(holding =>
                                holding.electronicAccess?.length > 0
                            ) || false;
                        }

                        instance.hasElectronicAccess = (instance.electronicAccess?.length > 0 || hasElectronicHoldings);

                        if (isMarcBased) {
                            let marcRecord = null;
                            if (instance.hrid !== 'N/A') {
                                const marcResponse = await fetch(`${OKAPI_URL}/source-storage/source-records?externalHrid=${instance.hrid}&recordType=MARC_BIB&limit=1`, {
                                    headers: { 'x-okapi-tenant': TENANT_ID, 'x-okapi-token': token, 'Accept': 'application/json' }
                                });
                                if (marcResponse.ok) {
                                    const marcData = await marcResponse.json();
                                    if (marcData.sourceRecords?.length > 0 && marcData.sourceRecords[0].parsedRecord?.content?.fields) {
                                        marcRecord = marcData.sourceRecords[0].parsedRecord.content.fields;
                                        instance.srsId = marcData.sourceRecords[0].recordId || instance.srsId;
                                    }
                                }
                            }

                            if (!marcRecord) {
                                const fallbackResponse = await fetch(`${OKAPI_URL}/source-storage/records?query=externalIdsHolder.instanceId=="${instance.id}" and recordType=="MARC_BIB"&limit=1`, {
                                    headers: { 'x-okapi-tenant': TENANT_ID, 'x-okapi-token': token, 'Accept': 'application/json' }
                                });
                                if (fallbackResponse.ok) {
                                    const fallbackData = await fallbackResponse.json();
                                    if (fallbackData.records?.length > 0 && fallbackData.records[0].parsedRecord?.content?.fields) {
                                        marcRecord = fallbackData.records[0].parsedRecord.content.fields;
                                    }
                                }
                            }

                            instance.marcFields = marcRecord ? extractMarcFields(marcRecord) : {};
                        } else {
                            instance.marcFields = {};
                        }
                    } catch (error) {
                        console.error(`Error fetching details for ${instance.id}:`, error);
                        instance.marcFields = {};
                        instance.srsId = 'N/A';
                        instance.hasElectronicAccess = instance.electronicAccess?.length > 0;
                    }
                    return instance;
                }));

                console.log('Processed Instances:', instancesWithDetails);
                currentResults = instancesWithDetails;
                displayResults(instancesWithDetails);
                updatePagination();
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('resultsTable').innerHTML = `<p>Error retrieving results: ${error.message}</p>`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function extractMarcFields(fields) {
            const marcFields = {};
            fields.forEach(field => {
                const tag = Object.keys(field)[0];
                const value = field[tag];
                if (typeof value === 'string') {
                    marcFields[tag] = value;
                } else if (value.subfields) {
                    marcFields[`${tag}_raw`] = `${value.ind1}${value.ind2} ${value.subfields.map(sf => {
                        const subKey = Object.keys(sf)[0];
                        return `$${subKey} ${sf[subKey]}`;
                    }).join(' ')}`;
                    marcFields[tag] = value.subfields.map(sf => {
                        const subKey = Object.keys(sf)[0];
                        return `${subKey}: ${sf[subKey]}`;
                    }).join('\n');
                    value.subfields.forEach(sf => {
                        const subKey = Object.keys(sf)[0];
                        marcFields[`${tag}$${subKey}`] = sf[subKey];
                    });
                }
            });
            return marcFields;
        }

        function getSelectedMarcFields() {
            return marcFieldsToDisplay;
        }

        function validateMarcField(field) {
            const marcRegex = /^\d{3}(?:\$\w)?$/;
            return marcRegex.test(field);
        }

        function updateMarcFieldTags() {
            const tagsDiv = document.getElementById('marcFieldTags');
            tagsDiv.innerHTML = '';
            const allFields = [...marcFieldsToDisplay.mainFields, ...marcFieldsToDisplay.subFields];
            allFields.forEach(field => {
                const tag = document.createElement('div');
                tag.className = 'marc-field-tag';
                tag.innerHTML = `
                    ${field} - ${marcFieldLabels[field] || 'Custom'}
                    <button class="remove-tag" onclick="removeMarcField('${field}')">√ó</button>
                `;
                tagsDiv.appendChild(tag);
            });
        }

        document.getElementById('marcFieldInput').addEventListener('input', (e) => {
            const input = e.target;
            const value = input.value.trim();
            if (value) {
                input.classList.toggle('valid', validateMarcField(value));
                input.classList.toggle('invalid', !validateMarcField(value));
            } else {
                input.classList.remove('valid', 'invalid');
            }
        });

        document.getElementById('marcFieldInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addMarcField();
            }
        });

        // Add MARC Field with Feedback
        function addMarcField() {
            const input = document.getElementById('marcFieldInput');
            const value = input.value.trim();

            if (!value) {
                input.classList.add('invalid');
                setTimeout(() => input.classList.remove('invalid'), 1000); // Brief flash
                return;
            }

            if (!validateMarcField(value)) {
                input.classList.add('invalid');
                input.title = 'Invalid format (e.g., 020 or 020$a)';
                setTimeout(() => {
                    input.classList.remove('invalid');
                    input.title = '';
                }, 1500);
                return;
            }

            const fields = value.split(',').map(f => f.trim()).filter(f => f);
            let added = false;
            fields.forEach(field => {
                if (field.includes('$')) {
                    if (!marcFieldsToDisplay.subFields.includes(field)) {
                        marcFieldsToDisplay.subFields.push(field);
                        added = true;
                    }
                } else {
                    if (!marcFieldsToDisplay.mainFields.includes(field)) {
                        marcFieldsToDisplay.mainFields.push(field);
                        added = true;
                    }
                }
            });

            if (added) {
                input.value = '';
                input.classList.add('valid');
                setTimeout(() => input.classList.remove('valid'), 1000); // Success flash
                updateMarcFieldTags();
            } else {
                input.classList.add('invalid');
                setTimeout(() => input.classList.remove('invalid'), 1000); // Duplicate flash
            }
        }

        // Update MARC Field Tags with Animation
        function updateMarcFieldTags() {
            const tagsDiv = document.getElementById('marcFieldTags');
            tagsDiv.innerHTML = '';
            const allFields = [...marcFieldsToDisplay.mainFields, ...marcFieldsToDisplay.subFields];

            allFields.forEach(field => {
                const tag = document.createElement('div');
                tag.className = 'marc-field-tag';
                tag.innerHTML = `
            ${field} - ${marcFieldLabels[field] || 'Custom'}
            <button class="remove-tag" onclick="removeMarcField('${field}')">√ó</button>
        `;
                tagsDiv.appendChild(tag);
                // Add a subtle fade-in animation
                tag.style.opacity = '0';
                setTimeout(() => {
                    tag.style.transition = 'opacity 0.3s';
                    tag.style.opacity = '1';
                }, 10);
            });
        }

        // Remove MARC Field with Animation
        window.removeMarcField = function (field) {
            const tag = Array.from(document.querySelectorAll('.marc-field-tag')).find(t => t.textContent.includes(field));
            if (tag) {
                tag.style.transition = 'opacity 0.3s';
                tag.style.opacity = '0';
                setTimeout(() => {
                    marcFieldsToDisplay.mainFields = marcFieldsToDisplay.mainFields.filter(f => f !== field);
                    marcFieldsToDisplay.subFields = marcFieldsToDisplay.subFields.filter(f => f !== field);
                    updateMarcFieldTags();
                }, 300);
            }
        };

        // Event Listeners
        document.getElementById('marcFieldInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addMarcField();
            }
        });

        document.getElementById('marcFieldInput').addEventListener('input', (e) => {
            const input = e.target;
            const value = input.value.trim();
            if (value) {
                input.classList.toggle('valid', validateMarcField(value));
                input.classList.toggle('invalid', !validateMarcField(value));
            } else {
                input.classList.remove('valid', 'invalid');
            }
        });

        document.getElementById('updateResults').addEventListener('click', () => {
            if (currentQuery) {
                displayResults(currentResults);
            }
        });

        function toggleMarcFields() {
            const content = document.getElementById('marcFieldsContent');
            content.classList.toggle('active');
            const header = content.previousElementSibling;
            header.textContent = header.textContent.replace(content.classList.contains('active') ? '‚ñæ' : '‚ñ∏', content.classList.contains('active') ? '‚ñ∏' : '‚ñæ');
        }

        function displayResults(instances) {
            const resultsDiv = document.getElementById('resultsTable');
            const summaryTextDiv = document.getElementById('summaryText');

            const cols = {
                title: document.getElementById('colTitle').checked,
                id: document.getElementById('colId').checked,
                hrid: document.getElementById('colHrid').checked,
                subjects: document.getElementById('colSubjects').checked,
                electronic: document.getElementById('colElectronic').checked,
                srsId: document.getElementById('colSrsId').checked
            };

            const { mainFields, subFields } = getSelectedMarcFields();

            const start = currentPage * pageSize + 1;
            const end = Math.min((currentPage + 1) * pageSize, totalRecords);
            summaryTextDiv.textContent = `Showing ${start} to ${end} of ${totalRecords} results`;

            if (instances.length === 0) {
                resultsDiv.innerHTML = '<p>No results found for this page.</p>';
                return;
            }

            let html = '<table><thead><tr>';
            if (cols.title) html += '<th>Title</th>';
            if (cols.id) html += '<th>Instance ID</th>';
            if (cols.hrid) html += '<th>HRID</th>';
            if (cols.subjects) html += '<th>Subjects</th>';
            if (cols.electronic) html += '<th>Electronic Access</th>';
            if (cols.srsId) html += '<th>SRS ID</th>';
            mainFields.forEach(field => html += `<th class="marc-field">${marcFieldLabels[field] || field}</th>`);
            subFields.forEach(field => html += `<th class="marc-field">${marcFieldLabels[field] || field}</th>`);
            html += '</tr></thead><tbody>';

            instances.forEach(instance => {
                html += '<tr>';
                if (cols.title) html += `<td>${instance.title || 'N/A'}</td>`;
                if (cols.id) html += `<td>${instance.id || 'N/A'}</td>`;
                if (cols.hrid) html += `<td>${instance.hrid || 'N/A'}</td>`;
                if (cols.subjects) html += `<td>${instance.subjects?.join(', ') || 'None'}</td>`;
                if (cols.electronic) html += `<td>${instance.hasElectronicAccess ? 'Yes' : 'No'}</td>`;
                if (cols.srsId) html += `<td>${instance.srsId || 'N/A'}</td>`;
                mainFields.forEach(field => {
                    html += `<td class="marc-field">${instance.marcFields[field] || ''}</td>`;
                });
                subFields.forEach(field => {
                    html += `<td class="marc-field">${instance.marcFields[field] || ''}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
            console.log('Results table HTML set');
        }

        function updatePagination() {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.classList.remove('hidden');
            const totalPages = Math.ceil(totalRecords / pageSize);
            const maxPagesToShow = 5;
            let startPage = Math.max(0, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow);

            if (endPage - startPage < maxPagesToShow && startPage > 0) {
                startPage = Math.max(0, endPage - maxPagesToShow);
            }

            let html = '<button onclick="changePage(0)" ' + (currentPage === 0 ? 'disabled' : '') + '>First</button>';
            html += '<button onclick="changePage(' + (currentPage - 1) + ')" ' + (currentPage === 0 ? 'disabled' : '') + '>Previous</button>';

            for (let i = startPage; i < endPage; i++) {
                html += `<button onclick="changePage(${i})" ${i === currentPage ? 'class="current-page"' : ''}>${i + 1}</button>`;
            }

            html += '<button onclick="changePage(' + (currentPage + 1) + ')" ' + (currentPage >= totalPages - 1 ? 'disabled' : '') + '>Next</button>';
            html += '<button onclick="changePage(' + (totalPages - 1) + ')" ' + (currentPage >= totalPages - 1 ? 'disabled' : '') + '>Last</button>';
            html += `<span>Page ${currentPage + 1} of ${totalPages} (${totalRecords} total records)</span>`;

            paginationDiv.innerHTML = html;
        }

        window.changePage = function (newPage) {
            if (newPage >= 0 && newPage < Math.ceil(totalRecords / pageSize)) {
                currentPage = newPage;
                fetchPage(currentPage);
            }
        };

        document.querySelectorAll('.column-select input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (currentQuery) displayResults(currentResults);
            });
        });

        function exportToCSV() {
            if (!currentResults.length) {
                alert('No results to export. Please perform a search first.');
                return;
            }
            const cols = {
                title: document.getElementById('colTitle').checked,
                id: document.getElementById('colId').checked,
                hrid: document.getElementById('colHrid').checked,
                subjects: document.getElementById('colSubjects').checked,
                electronic: document.getElementById('colElectronic').checked,
                srsId: document.getElementById('colSrsId').checked
            };

            const { mainFields, subFields } = getSelectedMarcFields();

            let csv = [];
            let headers = [];
            if (cols.title) headers.push('Title');
            if (cols.id) headers.push('Instance ID');
            if (cols.hrid) headers.push('HRID');
            if (cols.subjects) headers.push('Subjects');
            if (cols.electronic) headers.push('Electronic Access');
            if (cols.srsId) headers.push('SRS ID');
            mainFields.forEach(field => headers.push(marcFieldLabels[field] || field));
            subFields.forEach(field => headers.push(marcFieldLabels[field] || field));

            csv.push(headers.join(','));

            currentResults.forEach(instance => {
                let row = [];
                if (cols.title) row.push(`"${instance.title.replace(/"/g, '""')}"`);
                if (cols.id) row.push(`"${instance.id}"`);
                if (cols.hrid) row.push(`"${instance.hrid || 'N/A'}"`);
                if (cols.subjects) row.push(`"${instance.subjects?.join('; ') || 'None'}"`);
                if (cols.electronic) row.push(`"${instance.hasElectronicAccess ? 'Yes' : 'No'}"`);
                if (cols.srsId) row.push(`"${instance.srsId}"`);
                mainFields.forEach(field => {
                    row.push(`"${(instance.marcFields[field] || '').replace(/"/g, '""')}"`);
                });
                subFields.forEach(field => {
                    row.push(`"${(instance.marcFields[field] || '').replace(/"/g, '""')}"`);
                });
                csv.push(row.join(','));
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `folio_search_results_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportToJSON() {
            if (!currentResults.length) {
                alert('No results to export. Please perform a search first.');
                return;
            }
            const cols = {
                title: document.getElementById('colTitle').checked,
                id: document.getElementById('colId').checked,
                hrid: document.getElementById('colHrid').checked,
                subjects: document.getElementById('colSubjects').checked,
                electronic: document.getElementById('colElectronic').checked,
                srsId: document.getElementById('colSrsId').checked
            };

            const { mainFields, subFields } = getSelectedMarcFields();

            const jsonData = currentResults.map(instance => {
                let obj = {};
                if (cols.title) obj.title = instance.title;
                if (cols.id) obj.instanceId = instance.id;
                if (cols.hrid) obj.hrid = instance.hrid || 'N/A';
                if (cols.subjects) obj.subjects = instance.subjects || [];
                if (cols.electronic) obj.electronicAccess = instance.hasElectronicAccess ? 'Yes' : 'No';
                if (cols.srsId) obj.srsId = instance.srsId;
                mainFields.forEach(field => {
                    obj[`marc_${field}`] = instance.marcFields[field] || '';
                });
                subFields.forEach(field => {
                    obj[`marc_${field}`] = instance.marcFields[field] || '';
                });
                return obj;
            });

            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `folio_search_results_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>